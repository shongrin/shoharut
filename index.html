<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="Google Sheet.css">
</head>
<body>
  <div class="container">
    <form method="post"
          action="https://script.google.com/macros/s/AKfycbxTEINIbWjvY5af8J2TcTSpEa8JAMBMpGSGIsEB9Fg/dev"
          name="contact-form">

      <h4>הזמנת ציוד בה"ד 7</h4>

      <!-- school controls unchanged -->
      <label for="school">בחר בית ספר:</label>
      <select id="school" name="שם בית ספר">
        <option value="גן יבנה" data-hidden="דרום">גן יבנה</option>
        <option value="מרחבים" data-hidden="דרום">מרחבים</option>
        <option value="אופקים" data-hidden="דרום">אופקים</option>
        <option value="באר שבע" data-hidden="דרום">באר שבע</option>
        <option value="תל אביב" data-hidden="מרכז">תל אביב</option>
        <option value="הרצליה" data-hidden="מרכז">הרצליה</option>
        <option value="רחובות" data-hidden="מרכז">רחובות</option>
        <option value="קריית מוצקין" data-hidden="צפון">קריית מוצקין</option>
      </select>
      <input type="hidden" name="מחוז" id="school-region">

      <!-- submit region hidden population -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const form = document.querySelector('form[name="contact-form"]');
          const select = document.getElementById('school');
          const hidden = document.getElementById('school-region');
          form.addEventListener('submit', () => {
            hidden.value = select.options[select.selectedIndex].dataset.hidden;
          });
        });
      </script>

      <!-- Products container: initial visible product row (user will fill this) -->
      <div id="products-container">
        <div class="product-row">
          <div class="product-header">מוצר חדש</div>
          <div class="product-details">
            <input type="text" name="מזון[]" placeholder="שם המזון">
            <input type="text" name="כמות[]" placeholder="כמות">
            <input type="text" name="מטרה[]" placeholder="לאיזה מטרה">
            <div class="date-wrapper">
              <input type="date" name="תאריך קבלה[]">
            </div>
          </div>
        </div>
      </div>

      <button type="button" id="add-product">מוצר נוסף</button>
      <br><br>
      <input type="submit" value="הזמן" id="submit">
    </form>
  </div>

  <!-- Blank template for new product rows (keeps template separate from filled rows) -->
  <template id="product-template">
    <div class="product-row">
      <div class="product-header">מוצר חדש</div>
      <div class="product-details">
        <input type="text" name="מזון[]" placeholder="שם המזון">
        <input type="text" name="כמות[]" placeholder="כמות">
        <input type="text" name="מטרה[]" placeholder="לאיזה מטרה">
        <div class="date-wrapper">
          <input type="date" name="תאריך קבלה[]">
        </div>
      </div>
    </div>
  </template>

  <script src="Google Sheet.js"></script>

  <!-- Collapsible + add-row logic -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById('products-container');
    const addButton = document.getElementById('add-product');
    const tpl = document.getElementById('product-template');

    // Delegate header clicks to toggle that row open/closed
    container.addEventListener('click', (e) => {
      const hdr = e.target.closest('.product-header');
      if (!hdr) return;
      const row = hdr.closest('.product-row');
      row.classList.toggle('collapsed');
    });

    // Initialize a row: set header text & live-update while editing
    function setupRow(row) {
      const header = row.querySelector('.product-header');
      const nameInput = row.querySelector('input[name="מזון[]"]');
      if (!header || !nameInput) return;

      // set header initial text from input (if any)
      const initial = nameInput.value.trim();
      header.textContent = initial || 'מוצר חדש';

      // avoid double-attaching listeners
      if (row.dataset.inited === '1') return;
      row.dataset.inited = '1';

      // live update header while user types
      nameInput.addEventListener('input', () => {
        header.textContent = nameInput.value.trim() || 'מוצר חדש';
      });
    }

    // When add button pressed:
    // - collapse currently visible rows (turn them into header-buttons)
    // - create a NEW blank row from template and append it, expanded
    addButton.addEventListener('click', () => {
      // collapse currently expanded rows (those without .collapsed)
      const rows = Array.from(container.querySelectorAll('.product-row'));
      rows.forEach(r => {
        // set header from its inputs before collapsing
        const nameInput = r.querySelector('input[name="מזון[]"]');
        const header = r.querySelector('.product-header');
        if (nameInput && header) header.textContent = nameInput.value.trim() || 'מוצר חדש';
        r.classList.add('collapsed');
      });

      // create a fresh blank row from template (keeps filled values out of the new form)
      const frag = tpl.content.cloneNode(true);
      const newRow = frag.querySelector('.product-row');
      if (!newRow) return;

      // ensure new row is expanded
      newRow.classList.remove('collapsed');

      // append and setup
      container.appendChild(newRow);
      setupRow(newRow);

      // focus first input in the new row for quick typing
      const firstInput = newRow.querySelector('input[name="מזון[]"]');
      if (firstInput) firstInput.focus();
    });

    // initialize existing rows on page load (there is at least the original one)
    document.querySelectorAll('.product-row').forEach(r => {
      // start with the first row expanded (if you want it collapsed by default change this)
      r.classList.remove('collapsed');
      setupRow(r);
    });
  });
  </script>
</body>
</html>
